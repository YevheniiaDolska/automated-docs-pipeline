name: Monitor n8n for Documentation Gaps

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday 9:00 UTC
  workflow_dispatch:       # Manual trigger

jobs:
  check-releases:
    name: Check n8n GitHub releases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest n8n releases
        id: releases
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: 'n8n-io',
              repo: 'n8n',
              per_page: 5
            });

            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const recent = releases.filter(r => new Date(r.published_at) > oneWeekAgo);

            for (const release of recent) {
              const body = release.body || '';
              // Look for features (not just bug fixes)
              const hasFeatures = body.includes('### Features') ||
                                  body.includes('feat(') ||
                                  body.includes('feat:');

              if (hasFeatures) {
                // Extract feature lines
                const featureLines = body.split('\n')
                  .filter(l => l.includes('feat(') || l.includes('feat:'))
                  .slice(0, 10)
                  .join('\n');

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `üì¶ n8n ${release.tag_name}: new features may need documentation`,
                  body: `## n8n ${release.tag_name} released on ${release.published_at}\n\n` +
                        `### Features detected:\n\`\`\`\n${featureLines}\n\`\`\`\n\n` +
                        `**Full release:** ${release.html_url}\n\n` +
                        `### Action needed:\n` +
                        `- [ ] Review features for documentation impact\n` +
                        `- [ ] Create/update affected pages\n` +
                        `- [ ] Update version references if needed`,
                  labels: ['n8n-release', 'auto-created']
                });
              }
            }

            return recent.length;

  check-community:
    name: Check n8n community for doc gaps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch community questions
        id: community
        run: |
          # Fetch recent questions from n8n community RSS
          curl -s "https://community.n8n.io/c/questions/7.rss" \
            -o /tmp/community.xml 2>/dev/null || true

          # Parse titles (simple grep - works for RSS)
          if [ -f /tmp/community.xml ]; then
            grep -oP '<title><!\[CDATA\[\K[^\]]+' /tmp/community.xml \
              | head -20 > /tmp/topics.txt || true
          fi

          # Count topics (for summary)
          TOPIC_COUNT=$(wc -l < /tmp/topics.txt 2>/dev/null || echo "0")
          echo "topic_count=$TOPIC_COUNT" >> $GITHUB_OUTPUT

      - name: Create summary issue
        if: steps.community.outputs.topic_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let topics = '';
            try {
              topics = fs.readFileSync('/tmp/topics.txt', 'utf8');
            } catch (e) {
              topics = 'Could not fetch community topics this week.';
            }

            // Only create issue if there are topics
            if (topics.trim()) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîç Weekly community topics review - ${new Date().toISOString().split('T')[0]}`,
                body: `## Recent n8n community questions\n\n` +
                      `Review these for documentation gaps:\n\n` +
                      `\`\`\`\n${topics}\`\`\`\n\n` +
                      `**Source:** https://community.n8n.io/c/questions/7\n\n` +
                      `### Patterns to look for:\n` +
                      `- Repeated questions = missing/unclear docs\n` +
                      `- Unanswered questions = doc gap\n` +
                      `- Workaround discussions = doc improvement opportunity`,
                labels: ['community-gap', 'auto-created']
              });
            }
