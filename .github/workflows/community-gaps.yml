name: Community Documentation Gaps

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 09:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  analyze-community:
    name: Analyze Community Topics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Collect community topics
        run: |
          mkdir -p reports
          python3 -m scripts.gap_detection.cli community --limit 100 | tee reports/community-gap-report.txt

      - name: Create issue if topics found
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/community-gap-report.txt';
            const report = fs.existsSync(reportPath)
              ? fs.readFileSync(reportPath, 'utf8')
              : 'Community gap report was not generated.';

            const match = report.match(/Collected\s+(\d+)\s+topics/i);
            const count = match ? parseInt(match[1], 10) : 0;

            if (count > 0) {
              const date = new Date().toISOString().split('T')[0];
              const body = [
                '## Community Gap Report',
                '',
                `Collected topics: ${count}`,
                '',
                '```text',
                report.slice(0, 60000),
                '```',
              ].join('\n');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Docs] Weekly Community Gaps - ${date}`,
                body,
                labels: ['documentation', 'community-feedback', 'auto-created']
              });

              core.info(`Created issue with ${count} collected topics.`);
            } else {
              core.info('No actionable community topics found. No issue created.');
            }

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: community-gaps-report
          path: reports/community-gap-report.txt
