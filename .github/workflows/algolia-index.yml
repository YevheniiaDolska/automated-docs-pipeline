name: Update Algolia Search Index

on:
  push:
    branches: [main]
    paths:
      - 'docs/**/*.md'
  workflow_dispatch:

concurrency:
  group: algolia-index-${{ github.ref }}
  cancel-in-progress: true

env:
  # These secrets need to be set in GitHub repository settings
  ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
  ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_ADMIN_KEY }}
  ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME || 'docs' }}

jobs:
  update-search-index:
    name: Update Algolia index
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml "algoliasearch==2.6.3"

      - name: Generate search records
        run: |
          python scripts/seo_geo_optimizer.py docs/ --algolia --output algolia-records.json

      - name: Normalize generated records file
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          candidates = [
              Path("algolia-records.json"),
              Path("algolia-records-algolia.json"),
              Path("seo-output-algolia.json"),
          ]

          source = None
          for candidate in candidates:
              if candidate.exists():
                  source = candidate
                  break

          if source is None:
              raise SystemExit(
                  "No Algolia records file found. Expected one of: "
                  "algolia-records.json, algolia-records-algolia.json, seo-output-algolia.json"
              )

          payload = json.loads(source.read_text(encoding="utf-8"))

          # seo_geo_optimizer outputs {records, config}; workflow needs plain records list.
          if isinstance(payload, dict) and "records" in payload:
              records = payload["records"]
          elif isinstance(payload, list):
              records = payload
          else:
              raise SystemExit(f"Unsupported Algolia payload format in {source}")

          if not isinstance(records, list):
              raise SystemExit(f"Expected records list in {source}")

          Path("algolia-records.json").write_text(
              json.dumps(records, indent=2),
              encoding="utf-8",
          )
          print(f"Prepared algolia-records.json with {len(records)} records (source: {source})")
          PY

      - name: Push to Algolia
        run: |
          python3 - <<'PY'
          import json
          import os
          from algoliasearch.search_client import SearchClient

          # Initialize client
          client = SearchClient.create(
              os.environ["ALGOLIA_APP_ID"],
              os.environ["ALGOLIA_API_KEY"],
          )

          index_name = os.environ["ALGOLIA_INDEX_NAME"]
          index = client.init_index(index_name)

          # Load records
          with open("algolia-records.json", "r", encoding="utf-8") as handle:
              records = json.load(handle)

          # Configure index settings
          settings = {
              "searchableAttributes": [
                  "unordered(title)",
                  "unordered(heading)",
                  "unordered(content)",
                  "unordered(description)",
                  "tags",
              ],
              "attributesForFaceting": [
                  "searchable(product)",
                  "searchable(content_type)",
                  "searchable(component)",
                  "searchable(tags)",
                  "maturity",
                  "version",
              ],
              "customRanking": [
                  "desc(ranking_boost)",
                  "asc(heading_level)",
                  "desc(word_count)",
              ],
              "attributesToSnippet": [
                  "content:50",
                  "description:30",
              ],
              "distinct": True,
              "attributeForDistinct": "url",
          }

          # Update settings
          index.set_settings(settings)

          # Clear and upload records (atomic replace)
          index.clear_objects()
          response = index.save_objects(records)
          task_id = None
          if isinstance(response, dict):
              task_id = response.get("taskID") or response.get("taskId")
          elif isinstance(response, list) and response:
              first_item = response[0]
              if isinstance(first_item, dict):
                  task_id = first_item.get("taskID") or first_item.get("taskId")

          print(f"Uploaded {len(records)} records to Algolia")
          print(f"Index: {index_name}")
          print(f"Task ID: {task_id or 'n/a'}")
          PY

      - name: Test search
        continue-on-error: true
        run: |
          python3 - <<'PY'
          import os
          import time
          from algoliasearch.search_client import SearchClient

          # Wait for indexing
          time.sleep(5)

          client = SearchClient.create(
              os.environ["ALGOLIA_APP_ID"],
              os.environ["ALGOLIA_API_KEY"],
          )

          index = client.init_index(os.environ["ALGOLIA_INDEX_NAME"])

          # Test search
          result = index.search(
              "webhook",
              {
                  "facetFilters": [],
                  "hitsPerPage": 3,
              },
          )

          print("Search test results:")
          print(f"Found {result['nbHits']} results for 'webhook'")
          for hit in result["hits"][:3]:
              print(f"  - {hit.get('title', 'Untitled')}: {hit.get('url', '')}")
          PY

      - name: Generate search analytics report
        if: always()
        run: |
          echo "## Algolia Search Index Update" > search-report.md
          echo "" >> search-report.md
          echo "- **Date**: $(date)" >> search-report.md
          echo "- **Index**: $ALGOLIA_INDEX_NAME" >> search-report.md
          echo "- **Records**: $(jq length algolia-records.json)" >> search-report.md
          echo "" >> search-report.md
          echo "### Content Type Breakdown" >> search-report.md
          jq -r '.[].content_type' algolia-records.json | sort | uniq -c | while read count type; do
            echo "- $type: $count" >> search-report.md
          done

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: search-index-report
          path: |
            search-report.md
            algolia-records.json
