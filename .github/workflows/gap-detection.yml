name: Documentation Gap Detection

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ documentation gaps Ð¸Ð· Ñ‚Ñ€Ñ‘Ñ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²:
# 1. Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² ÐºÐ¾Ð´Ðµ (git diff Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ N Ð´Ð½ÐµÐ¹)
# 2. Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð² community (RSS feeds)
# 3. ÐŸÐ¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Algolia (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚)
#
# ÐÐ• Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÐºÐ¾Ð´ Ð²Ð¾ Ð²Ð½ÐµÑˆÐ½Ð¸Ðµ API â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·.
# Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Claude Code.

on:
  schedule:
    - cron: '0 8 * * 1'  # Every Monday 8:00 UTC
  workflow_dispatch:       # Manual trigger
    inputs:
      since_days:
        description: 'Analyze commits from last N days'
        required: false
        default: '7'

env:
  PYTHON_VERSION: '3.11'

jobs:
  analyze-gaps:
    name: Analyze Documentation Gaps
    runs-on: ubuntu-latest
    outputs:
      total_gaps: ${{ steps.analyze.outputs.total_gaps }}
      high_priority: ${{ steps.analyze.outputs.high_priority }}
      report_path: ${{ steps.analyze.outputs.report_path }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pyyaml openpyxl

      - name: Run gap analysis
        id: analyze
        run: |
          cd scripts
          python -m gap_detection.cli analyze \
            --repo .. \
            --since ${{ github.event.inputs.since_days || '7' }} \
            --output-dir ../reports

          # Extract metrics from JSON report
          if [ -f ../reports/doc_gaps_report.json ]; then
            TOTAL=$(jq '.summary.total_gaps' ../reports/doc_gaps_report.json)
            HIGH=$(jq '.summary.high_priority' ../reports/doc_gaps_report.json)
            echo "total_gaps=$TOTAL" >> $GITHUB_OUTPUT
            echo "high_priority=$HIGH" >> $GITHUB_OUTPUT
            echo "report_path=reports/doc_gaps_report.json" >> $GITHUB_OUTPUT
          fi

      - name: Upload reports to artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: gap-reports
          path: reports/
          retention-days: 30

      - name: Commit reports to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/
          git diff --staged --quiet || git commit -m "chore: update gap analysis reports [skip ci]"
          git push

      - name: Create summary issue
        if: steps.analyze.outputs.high_priority > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('reports/doc_gaps_report.json', 'utf8'));

            // Format high priority gaps
            const highPriority = report.gaps
              .filter(g => g.priority === 'high')
              .slice(0, 10);

            const gapList = highPriority.map(g =>
              `- **[${g.id}]** ${g.title}\n  - Type: ${g.suggested_doc_type} | Source: ${g.source}\n  - Action: ${g.action_required.substring(0, 100)}...`
            ).join('\n\n');

            const body = `## Documentation Gap Analysis - ${new Date().toISOString().split('T')[0]}

            ### Summary
            - **Total gaps found:** ${report.summary.total_gaps}
            - **High priority:** ${report.summary.high_priority}
            - **Medium priority:** ${report.summary.medium_priority}

            ### By Source
            ${Object.entries(report.summary.by_source).map(([k, v]) => `- ${k}: ${v}`).join('\n')}

            ### By Doc Type
            ${Object.entries(report.summary.by_doc_type).map(([k, v]) => `- ${k}: ${v}`).join('\n')}

            ---

            ### High Priority Gaps (Top 10)

            ${gapList}

            ---

            ### Next Steps (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð½Ð° Ñ‚Ð²Ð¾Ñ‘Ð¼ ÐŸÐš)
            1. \`git pull\` â€” Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ ÑƒÐ¶Ðµ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
            2. ÐžÑ‚ÐºÑ€Ð¾Ð¹ Claude Code Ð² Ð¿Ð°Ð¿ÐºÐµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            3. Ð¡ÐºÐ°Ð¶Ð¸: "Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¿Ð¾ reports/doc_gaps_report.json"

            **ÐžÑ‚Ñ‡Ñ‘Ñ‚Ñ‹:** \`reports/doc_gaps_report.json\` (Ð¸ .xlsx, .csv)`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Doc Gap Analysis: ${report.summary.high_priority} high priority gaps - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['doc-gaps', 'auto-created', 'needs-triage']
            });

  # Job generate-docs ÑƒÐ´Ð°Ð»Ñ‘Ð½ â€” Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚
  # Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Claude Code Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ (ÐºÐ¾Ð´ Ð½Ðµ ÑƒÑ…Ð¾Ð´Ð¸Ñ‚ Ð² API)

  notify-slack:
    name: Notify Slack
    needs: analyze-gaps
    if: always() && needs.analyze-gaps.outputs.high_priority > 0
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ðŸ“Š Documentation Gap Analysis Complete",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ“Š Doc Gap Analysis"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Total gaps:* ${{ needs.analyze-gaps.outputs.total_gaps }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*High priority:* ${{ needs.analyze-gaps.outputs.high_priority }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL || true
